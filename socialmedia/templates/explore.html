{% extends "layout.html" %}
{% load static %}

{% block title %}Explore{% endblock title %}



{% block content %}
<main role="main" class="main-content">
    {% include "modal.html" %}
    {% include "search.html" %}
    
    <!-- Layout Toggle -->
    <div class="container-fluid mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h2 font-bold gradient-text">Explore</h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" id="gridViewBtn">
                    <i class="fas fa-th-large"></i> Grid
                </button>
                <button type="button" class="btn btn-outline-primary" id="listViewBtn">
                    <i class="fas fa-list"></i> List
                </button>
            </div>
        </div>
    </div>
    
    <!-- Grid View -->
    <div class="container-fluid" id="gridView">
        <div class="explore-grid">
            {% for pos in post %}
            <article class="post-card">
                <!-- Header -->
                <header class="post-card__header">
                    <img src="{{pos.profileimg}}" 
                         alt="{{pos.user}}'s profile picture" 
                         class="post-card__avatar">
                    <div class="post-card__user-info">
                        <a href="/profile/{{pos.user}}" class="post-card__username">
                            @{{pos.user}}
                        </a>
                        <time class="post-card__timestamp">
                            {{pos.created_at|timesince}} ago
                        </time>
                    </div>
                    <div class="post-card__actions">
                        <button class="post-card__action-btn" title="More options">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </div>
                </header>
                
                <!-- Content -->
                <div class="post-card__content">
                    {% if pos.caption %}
                    <p class="post-card__caption">{{pos.caption}}</p>
                    {% endif %}
                    
                    {% if pos.image %}
                    <div class="post-card__media-container">
                       <img src="{{ pos.image.url }}"
                            class="post-card__image"
                            style="cursor:pointer;">



                        <div class="post-card__image-overlay"
                            data-bs-toggle="modal"
                            data-bs-target="#fullImageModal"
                            onclick="setModalImage('{{ pos.image.url }}' ,  '{{ pos.user }}' )">

                            <div class="post-card__overlay-content">
                                <a href="/profile/{{pos.user}}" class="post-card__overlay-username">
                                    @{{pos.user}}
                                </a>
                                {% if pos.caption %}
                                <p class="post-card__overlay-caption">
                                    {{pos.caption|truncatechars:100}}
                                </p>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                    {% endif %}
                </div>
                
                <!-- Footer -->
                <footer class="post-card__footer">
                    <div class="post-card__stats">
                        <div class="post-card__stat">
                            <i class="fas fa-heart post-card__stat-icon"></i>
                            <span>{{pos.no_of_like}}</span>
                        </div>
                        <div class="post-card__stat">
                            <i class="fas fa-comment post-card__stat-icon"></i>
                            <span>{{pos.comments.count}}</span>
                        </div>
                    </div>
                    
                    <div class="post-card" id="post-{{ pos.id }}">

                        <!-- ACTION BUTTONS -->
                        <div class="post-card__actions">

                            <!-- LIKE -->
                            <a href="{% url 'like-post' pos.id %}?from=explore " style="text-decoration: none;" 
                            class="post-card__action post-card__action--like {% if pos.is_liked %}post-card__action--active{% endif %}" data-post-id="{{pos.id}}">
                            <i class="{% if pos.is_liked %}fas fa-heart{% else %}far fa-heart{% endif %}"></i>
                            <span>Like</span>
                        </a>

                            <!-- COMMENT BUTTON -->
                            <button class="post-card__action comment-toggle-btn"
                                    data-post-id="{{ pos.id }}">
                                <i class="far fa-comment"></i>
                                <span>Comment</span>
                            </button>

                            <!-- SHARE -->
                            <button class="post-card__action">
                                <i class="far fa-share-square"></i>
                                <span>Share</span>
                            </button>
                        </div>

                        <!-- COMMENT SECTION (HIDDEN) -->
                        <div class="comments-section" id="comments-{{ pos.id }}">
                            <h4>Comments</h4>

                            {% for comment in pos.comments.all %}
                                <div class="comment">
                                    <strong>{{ comment.user.username }}</strong>
                                    <span>{{ comment.text }}</span>
                                </div>
                            {% empty %}
                                <p class="no-comments">No comments yet</p>
                            {% endfor %}

                            <form action="{% url 'add-comment' pos.id %}" method="POST">
                                {% csrf_token %}
                                <input type="text" name="comment" placeholder="Add a comment..." required>
                                <button type="submit">Post</button>
                            </form>
                        </div>

                    </div>
                </footer>
            </article>
            {% endfor %}
        </div>
    </div>
    

    <!-- List View (Hidden by default) -->
    <div class="container-fluid d-none" id="listView">
        <div class="row">
            {% for pos in post %}
            <div class="col-12 mb-4">
                <article class="post-card post-card--compact">
                    <div class="row g-0">
                        <div class="col-md-4">
                            {% if pos.image %}
                            <div class="post-card__media-container h-100">
                                <img src="{{ pos.image.url }}"
                                    class="post-card__image"
                                    style="cursor:pointer;">

                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <div class="post-card__content h-100 d-flex flex-column">
                                <header class="post-card__header border-0">
                                    <img src="{{pos.profileimg}}" 
                                         alt="{{pos.user}}'s profile picture" 
                                         class="post-card__avatar">

                                    <div class="post-card__user-info">
                                        <a href="/profile/{{pos.user}}" class="post-card__username">
                                            @{{pos.user}}
                                        </a>
                                        <time class="post-card__timestamp">
                                            {{pos.created_at|timesince}} ago
                                        </time>
                                    </div>
                                </header>
                                
                                {% if pos.caption %}
                                <p class="post-card__caption flex-grow-1">{{pos.caption}}</p>
                                {% endif %}
                                
                                <footer class="post-card__footer border-0 pt-0">
                                    <div class="post-card__actions-bar">
                                        <button class="post-card__action post-card__action--like">
                                            <i class="fas fa-heart post-card__action-icon"></i>
                                            {% if pos.no_of_like %}
                                            <span>{{pos.no_of_like}}</span>
                                            {% endif %}
                                        </button>
                                        
                                        <button class="post-card__action post-card__action--comment">
                                            <i class="fas fa-comment post-card__action-icon"></i>
                                            <span>{{pos.comments.count}}</span>
                                        </button>
                                    </div>
                                </footer>
                            </div>
                        </div>
                    </div>
                </article>
            </div>
            {% endfor %}
        </div>
    </div>





</main>

<!-- Modal for full image display -->
<div class="modal fade" id="fullImageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                
                <h5 class="modal-title" id="modalProfileName"></h5>
                {% comment %} <h5 class="modal-title">{{ pos.user_profile.profilename }}</h5> {% endcomment %}
                
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0 text-center">
                <img id="modalImage" class="img-fluid w-100 rounded" src="">
            </div>
        </div>
    </div>
</div>



<script>
   //comment section 
   
//this avoid from comment section getting open when reload 
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.comments-section').forEach(section => {
        section.style.display = 'none';
    });
});

document.querySelectorAll('.comment-toggle-btn').forEach(button => {
    button.addEventListener('click', function () {
        const postId = this.dataset.postId;
        const commentSection = document.getElementById('comments-' + postId);

        if (commentSection.style.display === 'block') {
            commentSection.style.display = 'none';
        } else {
            commentSection.style.display = 'block';
        }
    });
});


 // showing the full image   
function setModalImage(src , profileName) {
    document.getElementById("modalImage").src = src;
    document.getElementById("modalProfileName").textContent = profileName;
}






    // View Toggle Functionality
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const gridView = document.getElementById('gridView');
    const listView = document.getElementById('listView');
    
    gridViewBtn.addEventListener('click', () => {
        gridView.classList.remove('d-none');
        listView.classList.add('d-none');
        gridViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
    });
    
    listViewBtn.addEventListener('click', () => {
        gridView.classList.add('d-none');
        listView.classList.remove('d-none');
        gridViewBtn.classList.remove('active');
        listViewBtn.classList.add('active');
    });
    
    // Like Button Functionality
    document.querySelectorAll('.post-card__action--like').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            const isLiked = this.getAttribute('data-liked') === 'true';
            
            // Toggle state
            const newState = !isLiked;
            this.setAttribute('data-liked', newState);
            
            // Update UI
            if (newState) {
                this.classList.add('post-card__action--active');
                this.querySelector('.post-card__action-icon').className = 'fas fa-heart post-card__action-icon';
            } else {
                this.classList.remove('post-card__action--active');
                this.querySelector('.post-card__action-icon').className = 'far fa-heart post-card__action-icon';
            }
            
            // In a real app, you would make an API call here
            console.log(`Post ${postId} ${newState ? 'liked' : 'unliked'}`);
        });
    });
    
    // Image hover effect enhancement
    document.querySelectorAll('.post-card__media-container').forEach(container => {
        container.addEventListener('mouseenter', function() {
            this.style.transform = 'translateZ(10px)';
        });
        
        container.addEventListener('mouseleave', function() {
            this.style.transform = '';
        });
    });
</script>

{% endblock content %}